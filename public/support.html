<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Support - Swift Bank</title>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
body{
  font-family:Arial;
  background:#eef1f6;
  margin:0;
}

.container{
  max-width:600px;
  margin:40px auto;
  background:white;
  padding:25px;
  border-radius:15px;
  box-shadow:0 5px 20px rgba(0,0,0,0.1);
}

#chatBox{
  height:300px;
  overflow-y:auto;
  border:1px solid #ddd;
  border-radius:10px;
  padding:15px;
  margin-bottom:15px;
  background:#fafafa;
}

.message{
  margin-bottom:10px;
}

.user{
  text-align:right;
  color:#2f56b0;
}

.admin{
  text-align:left;
  color:#333;
}

input{
  width:75%;
  padding:12px;
  border-radius:10px;
  border:1px solid #ddd;
}

button{
  padding:12px 18px;
  border:none;
  border-radius:10px;
  background:#2f56b0;
  color:white;
  cursor:pointer;
}
</style>
</head>

<body>

<div class="container">
  <h2>Support Chat</h2>

  <div id="chatBox"></div>

  <input id="msgInput" placeholder="Type message...">
  <button onclick="sendMsg()">Send</button>
</div>

<script>

const token = localStorage.getItem("token")

if(!token){
  alert("Login required")
  window.location.href="/auth.html"
}

let socket
let userId

// ================= INIT =================
async function init(){

  try{

    const res = await fetch("/api/auth/me",{
      headers:{ Authorization:"Bearer "+token }
    })

    const user = await res.json()
    userId = user._id

    await loadOldMessages()
    connectSocket()

  }catch{
    localStorage.removeItem("token")
    window.location.href="/auth.html"
  }

}

init()

// ================= LOAD OLD MESSAGES =================
async function loadOldMessages(){

  try{

    const res = await fetch("/api/support/" + userId)
    const messages = await res.json()

    const chat = document.getElementById("chatBox")
    chat.innerHTML = ""

    messages.forEach(msg=>{
      addMessage(msg.sender,msg.message)
    })

  }catch(err){
    console.log("Load old messages error:", err)
  }

}

// ================= SOCKET =================
function connectSocket(){

  socket = io()

  socket.on("connect",()=>{
    console.log("âœ… Socket Connected")
    socket.emit("joinSupport",{ userId })
  })

  socket.on("newSupportMessage",(msg)=>{
    addMessage(msg.sender,msg.message)
  })

}

// ================= SEND MESSAGE =================
function sendMsg(){

  const input = document.getElementById("msgInput")

  if(!input.value.trim()) return

  socket.emit("supportUserMessage",{
    userId,
    message: input.value
  })

  input.value=""
}

// ================= UI MESSAGE =================
function addMessage(sender,text){

  const chat = document.getElementById("chatBox")

  const div = document.createElement("div")
  div.className = "message " + (sender === "admin" ? "admin" : "user")
  div.innerText = text

  chat.appendChild(div)
  chat.scrollTop = chat.scrollHeight
}

</script>

</body>
</html>
